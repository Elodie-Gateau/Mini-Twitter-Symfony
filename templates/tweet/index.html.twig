{% extends 'base.html.twig' %}

{% block title %}Fil d’actualité{% endblock %}

{% block body %}
<div class="bg-gray-50 dark:bg-gray-900 min-h-screen pt-16 transition-colors duration-300">
  <main class="max-w-2xl mx-auto p-4 space-y-6">

    {% if app.user %}
      <!-- Bouton créer un tweet -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 flex justify-between items-center">
        <span class="font-semibold text-gray-700 dark:text-gray-100">Exprime-toi !</span>
        <a href="{{ path('app_tweet_new') }}" class="bg-orange-500 hover:bg-orange-600 text-white text-sm px-4 py-2 rounded-lg">Créer</a>
      </div>
{% if tweets|length > 0 %}
      {% for tweet in tweets %}
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <!-- User info -->
        <div class="flex items-center justify-between gap-3 mb-3">
                <div class="flex items-center gap-3 mb-3">
          {# Photo de profil #}
                    	{% if tweet.idUser.isActive and tweet.idUser.photo is not null %}
												<img class="w-12 h-12 rounded-full" src="{{ asset('uploads/photos/' ~ tweet.idUser.photo) }}" alt="Photo de {{ tweet.idUser.name }}">
											{% else %}
												<img class="w-12 h-12 rounded-full" src="{{ asset('img/personne.png') }}" alt="Photo de {{ tweet.idUser.isActive ? tweet.idUser.name : "utilisateur anonyme" }}">
											{% endif %}
          <div>
          {# Pseudo #}
            <div class="font-semibold text-gray-900 dark:text-gray-100">
              {{ tweet.idUser.isActive ? tweet.idUser.nickname : "Utilisateur anonyme" }}
            </div>

			<a class="bg-orange-500 hover:bg-orange-500 text-white font-bold py-2 px-4 border border-orange-700 rounded" href="{{ path('app_tweet_new') }}">Créer un tweet</a>


			{% for tweet in tweets %}
				{# Cards tweet #}
				<div
					class="w-100 rounded-xl shadow-lg p-5 flex flex-col items-center">

					{# Entête de card #}
					<div class="flex w-100 justify-between p-5">
						<div
							class="flex gap-3 items-center">
							{# Photo de profil #}
							{% if tweet.idUser.photo is not null %}

								<a href="{{ path('app_profile_show', {'id': tweet.idUser.id}) }}"><img class="w-10 h-10 rounded mr-2" src="{{ asset('uploads/photos/' ~ tweet.idUser.photo) }}" alt="Photo de {{ tweet.idUser.name }}"></a>

							{% elseif tweet.idUser.photo is null or tweet.idUser.isActive == 0 %}
								<img class="w-10 h-10 rounded mr-2" src="{{ asset('img/personne.png') }}" alt="Photo de {{ tweet.idUser.isActive ? tweet.idUser.name : " anonyme"}}">
							{% endif %}

							{# Nom et date du tweet #}
							<div class="flex flex-col">
								<h2 class="font-bold text-xl mb-1">{{ tweet.idUser.isActive ? tweet.idUser.nickname : "Utilisateur anonyme" }}</h2>

								{# Conversion du mois en français #}
								{% set enMonth = tweet.creationTime|date('F') %}
								{% set frMonth = {
                'January': 'Janvier',
                'February': 'Février',
                'March': 'Mars',
                'April': 'Avril',
                'May': 'Mai',
                'June': 'Juin',
                'July': 'Juillet',
                'August': 'Août',
                'September': 'Septembre',
                'October': 'Octobre',
                'November': 'Novembre',
                'December': 'Décembre'
              } %}
              {{ tweet.creationTime|date('d') ~ ' ' ~ frMonth[enMonth] ~ ' ' ~ tweet.creationTime|date('H:i') }}
            </div>

								</h3>

							</div>

						</div>

						<div
							class="flex flex-row items-center gap-3">
							{# Bouton signaler le tweet #}
							{% if app.user %}
								{% if app.user.id != tweet.idUser.id %}
									{{ include('tweet/_signal_form.html.twig') }}
								{% endif %}
							{% endif %}

							{# Bouton modifier le tweet #}
							{% if app.user %}
								{% if app.user.id == tweet.idUser.id %}
									<a class="self-center font-bold text-orange-500" href="{{ path('app_tweet_edit', {'id': tweet.id}) }}">Modifier</a>
								{% endif %}
							{% endif %}

						</div>
					</div>
					{# retweet #}
					{# Si c'est un retweet AVEC un commentaire #}
					{% if tweet.originalTweet and tweet.content %}
						<p class="retweet-comment">
							<a href="{{ path('app_tweet_show', {'id': tweet.id}) }}" class="text-gray-700 text-base self-start py-1">
								{{ tweet.content}}
							</a>
						</p>
					{% endif %}

					{# Affichage du tweet original si c'est un retweet #}
					{% if tweet.originalTweet %}
						<div class="bg-gray-100 p-4 rounded-lg mb-4 border border-gray-300">
							<p class="text-gray-700 mb-2 text-sm">
								<span class="font-semibold">{{ tweet.idUser.name }}</span>
								a retweeté :

							</p>
							<div class="bg-white p-3 rounded-lg border border-gray-200">
								<p>
									<a href="{{ path('app_tweet_show', {'id': tweet.originalTweet.id}) }}" class="text-gray-700 text-base self-start py-1">{{ tweet.originalTweet.content }}</a>
								</p>
								<small class="text-gray-500 text-sm">
									Original de
									{{ tweet.originalTweet.idUser.name }}
									publié le
									{{ tweet.originalTweet.creationTime|date('d/m/Y H:i') }}
								</small>
							</div>
						</div>
					{% else %}
						{# Contenu du tweet #}
						<p>
							<a href="{{ path('app_tweet_show', {'id': tweet.id}) }}" class="text-gray-700 text-base self-start py-1">
								{{ tweet.content }}
							</a>
						</p>
					{% endif %}

					{# Futur emplacement des tags #}
					{# <div class="px-6 pt-4 pb-2">
										<span class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2">#tag</span>
										<span class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2">#tag</span>
										<span class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2">#tag</span>
										</div>  #}

        <!-- Actions -->
        <div class="flex justify-between items-center text-sm border-t border-gray-200 dark:border-gray-700 pt-3">
        {# Likes #}
          <div>{{ include('tweet/_like_form.html.twig') }}</div>
          {# Commentaires #}
          <a href="{{ path('app_tweet_index_comment', {'id': tweet.id}) }}"
             class="text-gray-600 dark:text-gray-300 hover:text-blue-500">
            {{ tweet.comment|length }} commentaire{{ tweet.comment|length > 1 ? 's' : '' }}
          </a>
          {# Signaler #}
          <div>{{ include('tweet/_signal_form.html.twig') }}</div>
        </div>

        <!-- Comments -->
        {% if selectedTweet is defined and selectedTweet.id == tweet.id %}
          <div class="mt-4 w-full p-4 bg-gray-100 dark:bg-gray-700 rounded">

            <h4 class="font-semibold mb-2">Commentaires :</h4>
            {% for comment in selectedTweet.comment|sort((a, b) => b.dateTime <=> a.dateTime) %}

              <div id="{{ comment.id }}" class="mb-2 border-b pb-2">

                <div class="flex justify-between items-center mb-2">

						{# Likes #}
						{{ include('tweet/_like_form.html.twig') }}

						{# Nombre de commentaires #}

						<a id="comment-count-{{ tweet.id }}" class="font-weight-medium" href="{{ path('app_tweet_comments_index', {'id': tweet.id}) }}">
							{{ tweet.comment|length }}
							commentaire{{ tweet.comment|length > 1 ? "s" : "" }}
						</a>

						{# Bouton Signaler #}
						{{ include('tweet/_signal_form.html.twig') }}

						{# Bouton Retweeter #}
						{% if app.user and tweet.idUser.id != app.user.id %}
							<div class="mt-4">
								<form action="{{ path('app_tweet_retweet', {'id': tweet.id}) }}" method="post" class="inline-block">
									<button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 ease-in-out">
										Retweeter
									</button>
								</form>
							</div>
						{% endif %}
					</div>

					{# SECTION COMMENTAIRES #}
					{% if selectedTweet is defined and selectedTweet.id == tweet.id %}
						<div
							class="mt-4 w-90 p-4 bg-gray-100 rounded">

							{# Formulaire d'ajout du commentaire #}
							<h5 class="mt-4 mb-3 font-semibold">Ajouter un commentaire :</h5>
							{% if commentForm is defined %}
								{{ include('comment/_add_form.html.twig', { form: commentForm }) }}
							{% endif %}

							{# Affichage des commentaires (s'il y en a) #}
							<h4 class="font-semibold mt-5 mb-2">Commentaires :</h4>

							{% for comment in comments|sort((a, b) => b.dateTime <=> a.dateTime) %}
								<div id="{{ comment.id }}" class="mb-2 border-b pb-2">
									<div
										class="flex justify-between items-center my-4">

										{# Photo de profil du commentateur #}
										<div class="flex flex-row gap-1 items-center">
											{% if comment.user.photo is not null %}
												<img class="w-10 h-10 rounded mr-2" src="{{ asset('uploads/photos/' ~ comment.user.photo) }}" alt="Photo de {{ comment.user.name }}">
											{% elseif comment.user.photo is null or comment.user.isActive == 0 %}
												<img class="w-10 h-10 rounded mr-2" src="{{ asset('img/personne.png') }}" alt="Photo de {{ comment.user.isActive ? comment.user.name : " personne anonyme" }}">
											{% endif %}

											{# Peudonyme du commentateur #}
											<p class="text-sm text-gray-700 font-semibold">{{ comment.user.isActive ? comment.user.nickname : "Utilisateur anonyme" }}</p>
										</div>
										{# Conversion du mois en français #}
										{% set moisAnglais = comment.dateTime|date('F') %}
										{% set moisFr = {
                  'January': 'Janvier',
                  'February': 'Février',
                  'March': 'Mars',
                  'April': 'Avril',
                  'May': 'Mai',
                  'June': 'Juin',
                  'July': 'Juillet',
                  'August': 'Août',
                  'September': 'Septembre',
                  'October': 'Octobre',
                  'November': 'Novembre',
                  'December': 'Décembre'
                } %}

										<p class="text-sm text-gray-500 font-regular">
											{% if comment.dateTime %}

												{{ comment.dateTime|date('d') ~ 

                    ' ' ~ moisFr[moisAnglais] ~ ' '
                
                    ~ comment.dateTime|date('H:i') }}

         
                    	{% if comment.user.isActive and comment.user.photo is not null %}
												<img class="w-8 h-8 rounded-full" src="{{ asset('uploads/photos/' ~ comment.user.photo) }}" alt="Photo de {{ comment.user.name }}">
											{% else %}
												<img class="w-8 h-8 rounded-full" src="{{ asset('img/personne.png') }}" alt="Photo de {{ comment.user.isActive ? comment.user.name : "utilisateur anonyme" }}">
											{% endif %}

									</div>
									<div
										class="my-2">

										{# Texte du commentaire #}
										<p>{{ comment.content }}</p>

										{# Médias du commentaire #}
										{% if comment.media|length > 0 %}
											{% for media in comment.media %}
												<div class="flex justify-between flex-wrap gap-1">
													<img class="py-2 w-{{ comment.media|length > 1 ? " 40" : " 100" }}" src="{{ media.urlMedia }}" alt="">
												</div>
											{% endfor %}
										{% endif %}
									</div>

									<div
										class="flex flex-row justify-between gap-2 py-1 w-full">

										{# Bouton liker le commentaire #}
										{{ include('comment/_like_form.html.twig') }}

										{# Bouton Signaler le commentaire #}
										{% if app.user %}
											{% if app.user.id != comment.user.id %}
												{{ include('comment/_signal_form.html.twig') }}
											{% endif %}
										{% endif %}

										{# Bouton modifier le commentaire #}
										{% if app.user %}
											{% if app.user.id == comment.user.id %}
												<div class="flex flex-row gap-1">
													<a class="leading-none text-sm text-blue-600 font-medium cursor-pointer hover:text-blue-400 duration-200 ease-in-out" href="{{ path('app_comment_edit', {'id': comment.id}) }}">Modifier</a>
												{% endif %}
											{% endif %}

											{# Bouton supprimer le commentaire #}
											{% if app.user %}
												{% if app.user.id == comment.user.id %}
													<div class="leading-none text-sm text-red-600 font-medium cursor-pointer hover:text-red-400 duration-200 ease-in-out">
														{{ include('comment/_delete_form.html.twig') }}
													</div>
												</div>
											{% endif %}
										{% endif %}
									</div>
								</div>
							{% else %}
								<p class="text-sm text-gray-500">Aucun commentaire pour ce tweet.</p>
							{% endfor %}

	            <h5 class="mt-4 mb-3 font-semibold">Ajouter un commentaire :</h5>
            {{ include('comment/_add_form.html.twig') }}
          </div>
        {% endif %}
      </div>
      {% endfor %}
{% else %}
    <p class="text-center text-gray-500 dark:text-gray-400">Aucun tweet trouvé</p>
{% endif %}
      <!-- Pagination -->
      {% if totalPages > 1 %}
        <div class="flex justify-center mt-10 gap-4">
          {% if currentPage > 1 %}
            <a href="{{ path('app_tweet_index', {'page': currentPage - 1}) }}" class="px-4 py-2 bg-gray-200 rounded">← Précédent</a>
          {% endif %}
          {% for p in 1..totalPages %}
            <a href="{{ path('app_tweet_index', {'page': p}) }}" class="px-3 py-1 rounded {{ p == currentPage ? 'bg-orange-500 text-white' : 'bg-gray-200' }}">
              {{ p }}
            </a>
          {% endfor %}
          {% if currentPage < totalPages %}
            <a href="{{ path('app_tweet_index', {'page': currentPage + 1}) }}" class="px-4 py-2 bg-gray-200 rounded">Suivant →</a>
          {% endif %}
        </div>
      {% endif %}

			{# PAGINATION DES TWEETS + COMMENTAIRES #}

			{# Pagination des tweets #}
			{% if totalPages is defined and totalPages > 1 %}
				<div class="flex justify-center mt-10 gap-4">
					{% if currentPage > 1 %}
						<a href="{{ path('app_tweet_index', {'page': currentPage - 1}) }}" class="px-4 py-2 bg-gray-200 rounded">← Précédent</a>
					{% endif %}

					{% for p in 1..totalPages %}
						<a href="{{ path('app_tweet_index', {'page': p}) }}" class="px-3 py-1 rounded {{ p == currentPage ? 'bg-orange-500 text-white' : 'bg-gray-200' }}">
							{{ p }}
						</a>
					{% endfor %}

					{% if currentPage < totalPages %}
						<a href="{{ path('app_tweet_index', {'page': currentPage + 1}) }}" class="px-4 py-2 bg-gray-200 rounded">Suivant →</a>
					{% endif %}
				</div>
			{% endif %}

			{# Pagination des commentaires #}
			{% if commentTotalPages is defined and commentTotalPages > 1 %}
				<div class="flex justify-center mt-4 gap-4">
					{% if commentCurrentPage > 1 %}
						<a href="{{ path('app_tweet_comments_index', {'id': selectedTweet.id, 'page': commentCurrentPage - 1}) }}" class="px-3 py-1 bg-gray-200 rounded">← Précédent</a>
					{% endif %}

					{% for p in 1..commentTotalPages %}
						<a href="{{ path('app_tweet_comments_index', {'id': selectedTweet.id, 'page': p}) }}" class="px-3 py-1 rounded {{ p == commentCurrentPage ? 'bg-orange-500 text-white' : 'bg-gray-200' }}">
							{{ p }}
						</a>
					{% endfor %}

					{% if commentCurrentPage < commentTotalPages %}
						<a href="{{ path('app_tweet_comments_index', {'id': selectedTweet.id, 'page': commentCurrentPage + 1}) }}" class="px-3 py-1 bg-gray-200 rounded">Suivant →</a>
					{% endif %}
				</div>
			{% endif %}

		</section>

		{# Si le visiteur n'est pas connecté avec un compte, il ne verra aucun tweet #}
	{% else %}
		<div class="flex flex-col h-100 items-center justify-around">
			<p>Connectez-vous pour accéder à l'ensemble des tweets !</p>
			<a href="{{ path('app_login')}}" class="bg-orange-500 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded">Se connecter</a>
		</div>

	{% endif %}
{% endblock %}
